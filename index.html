<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Wallet Tracker</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        /* Simple spinner animation */
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-6 text-slate-800 font-sans">
    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üïµÔ∏è Solana Wallet Tracker</h1>
            <p class="text-blue-100">Find diamond hands who bought early and held strong</p>
        </div>

        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white/20 shadow-xl">
            <h2 class="text-2xl font-bold text-white mb-4">‚öôÔ∏è Configuration</h2>

            <div class="grid md:grid-cols-1 gap-4 mb-4">
                <div>
                    <label for="apiKeyInput" class="block text-white mb-2 font-medium">
                        üîë BitQuery API Key 
                        <span class="text-xs font-normal text-blue-200 ml-2">(Saved locally in your browser)</span>
                    </label>
                    <input type="password" id="apiKeyInput" 
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors"
                           placeholder="Enter your BitQuery API key here (starts with ory_...)">
                </div>
            </div>
            
            <div class="grid md:grid-cols-1 gap-4 mb-4">
                <div>
                    <label for="tokenCA" class="block text-white mb-2 font-medium">Token Contract Address</label>
                    <input type="text" id="tokenCA" value="8Jx8AAHj86wbQgUTjGuj6GTTL5Ps3cqxKRTvpaJApump"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="startTime" class="block text-white mb-2 font-medium">üìÖ Buy Window Start</label>
                    <input type="datetime-local" id="startTime"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
                <div>
                    <label for="buyWindowEnd" class="block text-white mb-2 font-medium">üìÖ Buy Window End</label>
                    <input type="datetime-local" id="buyWindowEnd"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
                <div>
                    <label for="holdingCheckTime" class="block text-white mb-2 font-medium">üìÖ Holding Check Time</label>
                    <input type="datetime-local" id="holdingCheckTime"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="minBuyUSD" class="block text-white mb-2 font-medium">üí∞ Minimum Buy Amount (USD)</label>
                    <input type="number" id="minBuyUSD" value="100" min="0"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
                <div>
                    <label for="minHoldingPct" class="block text-white mb-2 font-medium">üìà Minimum Holding (% of Supply)</label>
                    <input type="number" id="minHoldingPct" value="0.1" step="0.01" min="0"
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400 transition-colors">
                </div>
            </div>

            <button onclick="runAnalysis()" id="analyzeBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-bold text-lg hover:from-blue-600 hover:to-purple-700 active:scale-[0.99] transition-all shadow-lg flex justify-center items-center gap-2">
                <span>üîç</span> Run Analysis
            </button>
        </div>

        <div id="statusMsg" class="hidden mb-6 transition-all duration-300"></div>

        <div id="resultsPanel" class="hidden bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20 shadow-xl">
            <h2 class="text-2xl font-bold text-white mb-4">üìä Results</h2>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-500/20 rounded-lg p-4 border border-blue-400/30">
                    <div class="text-blue-200 text-sm mb-1 uppercase tracking-wider font-semibold">Total Supply</div>
                    <div id="totalSupply" class="text-white text-2xl font-bold font-mono">-</div>
                </div>
                <div class="bg-purple-500/20 rounded-lg p-4 border border-purple-400/30">
                    <div class="text-purple-200 text-sm mb-1 uppercase tracking-wider font-semibold">Total Buyers</div>
                    <div id="totalBuyers" class="text-white text-2xl font-bold font-mono">-</div>
                </div>
                <div class="bg-green-500/20 rounded-lg p-4 border border-green-400/30">
                    <div class="text-green-200 text-sm mb-1 uppercase tracking-wider font-semibold">Diamond Hands üíé</div>
                    <div id="diamondHands" class="text-white text-2xl font-bold font-mono">-</div>
                </div>
            </div>

            <div id="walletsTable" class="overflow-x-auto rounded-lg border border-white/10"></div>
        </div>
    </div>

    <script>
        // Initialize Dates to meaningful defaults (Recent)
        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const twoDaysAgo = new Date(now.getTime() - (48 * 60 * 60 * 1000));
            const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
            
            // Helper to format date for datetime-local input (YYYY-MM-DDTHH:MM)
            const fmt = (d) => d.toISOString().slice(0, 16);

            document.getElementById('startTime').value = fmt(twoDaysAgo);
            document.getElementById('buyWindowEnd').value = fmt(oneDayAgo);
            document.getElementById('holdingCheckTime').value = fmt(now);

            // Load API Key from LocalStorage if exists
            const savedKey = localStorage.getItem('bitquery_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
            }
        });

        function showStatus(message, isError = false, isLoading = false) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.className = `${isError ? 'bg-red-500/20 border-red-500/50' : 'bg-blue-500/20 border-blue-500/50'} backdrop-blur-lg rounded-2xl p-4 mb-6 border transition-all`;
            
            let icon = isError ? '‚ùå' : '‚ÑπÔ∏è';
            if (isLoading) icon = '<div class="loader"></div>';

            statusMsg.innerHTML = `<div class="flex items-center gap-3 ${isError ? 'text-red-200' : 'text-blue-200'}">
                <span class="flex-shrink-0">${icon}</span>
                <span class="font-medium">${message}</span>
            </div>`;
            statusMsg.classList.remove('hidden');
        }

        async function copyToClipboard(text, buttonElement) {
            try {
                await navigator.clipboard.writeText(text);
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '‚úì';
                buttonElement.classList.remove('bg-blue-500/30');
                buttonElement.classList.add('bg-green-500');
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                    buttonElement.classList.remove('bg-green-500');
                    buttonElement.classList.add('bg-blue-500/30');
                }, 1500);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
        }

        async function runAnalysis() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const tokenCA = document.getElementById('tokenCA').value.trim();
            const startTime = document.getElementById('startTime').value;
            const buyWindowEnd = document.getElementById('buyWindowEnd').value;
            const holdingCheckTime = document.getElementById('holdingCheckTime').value;
            const minBuyUSD = document.getElementById('minBuyUSD').value;
            const minHoldingPct = document.getElementById('minHoldingPct').value;

            // 1. Validation
            if (!apiKey) {
                showStatus('Please enter your BitQuery API key.', true);
                return;
            }
            // Save key for future use
            localStorage.setItem('bitquery_key', apiKey);

            if (!tokenCA) {
                showStatus('Please enter a Token Contract Address.', true);
                return;
            }

            // UI State Update
            const btn = document.getElementById('analyzeBtn');
            const originalBtnText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Processing...';
            document.getElementById('resultsPanel').classList.add('hidden');

            try {
                // --- Step 1: Get Total Supply ---
                showStatus('Step 1/3: Fetching token supply from Solana RPC...', false, true);
                
                let totalSupply = 1000000000; // Default fallback
                
                try {
                    const supplyResponse = await fetch('https://api.mainnet-beta.solana.com', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0',
                            id: 1,
                            method: 'getTokenSupply',
                            params: [tokenCA]
                        })
                    });
                    const supplyData = await supplyResponse.json();
                    if (supplyData.result?.value) {
                        totalSupply = parseFloat(supplyData.result.value.amount) / Math.pow(10, supplyData.result.value.decimals);
                    }
                } catch (e) {
                    console.warn('RPC failed, using default supply', e);
                }

                // --- Step 2: Get Buyers ---
                showStatus('Step 2/3: Finding early buyers via BitQuery...', false, true);
                
                const buyersQuery = {
                    query: `
                        query ($token: String!, $start: DateTime!, $end: DateTime!, $min_usd: String!) {
                            Solana {
                                DEXTradeByTokens(
                                    where: {
                                        Trade: {
                                            Currency: {MintAddress: {is: $token}},
                                            Side: {
                                                Type: {is: buy},
                                                AmountInUSD: {gt: $min_usd}
                                            },
                                            PriceInUSD: {gt: 0}
                                        }
                                        Block: {
                                            Time: {
                                                since: $start,
                                                till: $end
                                            }
                                        }
                                    }
                                    limit: {count: 100}
                                ) {
                                    Trade { Account { Owner } }
                                    boughtVolume: sum(of: Trade_Amount)
                                    boughtVolumeUSD: sum(of: Trade_Side_AmountInUSD)
                                }
                            }
                        }
                    `,
                    variables: {
                        token: tokenCA,
                        start: startTime + ':00Z',
                        end: buyWindowEnd + ':00Z',
                        min_usd: minBuyUSD.toString()
                    }
                };

                const buyersResponse = await fetch('https://streaming.bitquery.io/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(buyersQuery)
                });

                const buyersData = await buyersResponse.json();
                
                if (buyersData.errors) throw new Error(buyersData.errors[0].message);
                
                const buyers = buyersData.data?.Solana?.DEXTradeByTokens?.map(t => ({
                    wallet: t.Trade.Account.Owner,
                    boughtVolume: parseFloat(t.boughtVolume),
                    costUSD: parseFloat(t.boughtVolumeUSD)
                })) || [];

                if (buyers.length === 0) {
                    throw new Error("No buyers found in this time window with these criteria.");
                }

                // --- Step 3: Check Holdings ---
                showStatus(`Step 3/3: Checking current balances for ${buyers.length} wallets...`, false, true);

                const balanceQuery = {
                    query: `
                        query ($token: String!, $time_check: DateTime!, $wallets: [String!]) {
                            Solana {
                                BalanceUpdates(
                                    where: {
                                        BalanceUpdate: {
                                            Currency: {MintAddress: {is: $token}},
                                            Account: {Owner: {in: $wallets}}
                                        }
                                        Block: {Time: {till: $time_check}}
                                    }
                                ) {
                                    BalanceUpdate {
                                        Account { Owner }
                                    }
                                    balance_at_time: sum(of: BalanceUpdate_Amount)
                                }
                            }
                        }
                    `,
                    variables: {
                        token: tokenCA,
                        time_check: holdingCheckTime + ':00Z',
                        wallets: buyers.map(b => b.wallet)
                    }
                };

                const balanceResponse = await fetch('https://streaming.bitquery.io/graphql', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(balanceQuery)
                });

                const balanceData = await balanceResponse.json();
                if (balanceData.errors) throw new Error(balanceData.errors[0].message);

                const balanceMap = {};
                balanceData.data?.Solana?.BalanceUpdates?.forEach(item => {
                    const owner = item.BalanceUpdate.Account.Owner;
                    balanceMap[owner] = Math.max(0, parseFloat(item.balance_at_time));
                });

                // Filter and Calculate
                const finalWallets = buyers
                    .map(buyer => {
                        const balance = balanceMap[buyer.wallet] || 0;
                        const pctSupply = (balance / totalSupply) * 100;
                        return { ...buyer, balanceAtCheckTime: balance, pctSupply };
                    })
                    .filter(w => w.pctSupply >= parseFloat(minHoldingPct))
                    .sort((a, b) => b.pctSupply - a.pctSupply);

                displayResults(totalSupply, buyers.length, finalWallets);
                showStatus('‚úÖ Analysis complete!', false);

            } catch (err) {
                showStatus(err.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        function displayResults(totalSupply, totalBuyers, wallets) {
            document.getElementById('totalSupply').textContent = totalSupply.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('totalBuyers').textContent = totalBuyers;
            document.getElementById('diamondHands').textContent = wallets.length;

            const tableContainer = document.getElementById('walletsTable');
            tableContainer.innerHTML = ''; // Clear previous

            if (wallets.length === 0) {
                tableContainer.innerHTML = '<div class="text-center text-white/70 py-8">No wallets met the holding criteria</div>';
            } else {
                const table = document.createElement('table');
                table.className = 'w-full text-white';
                
                // Create Header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr class="border-b border-white/20 bg-black/20">
                        <th class="text-left py-3 px-4">Wallet Address</th>
                        <th class="text-right py-3 px-4">Bought (USD)</th>
                        <th class="text-right py-3 px-4">Balance Held</th>
                        <th class="text-right py-3 px-4">% of Supply</th>
                    </tr>
                `;
                table.appendChild(thead);

                // Create Body
                const tbody = document.createElement('tbody');
                wallets.forEach((w) => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-white/10 hover:bg-white/5 transition-colors';
                    
                    const gmgnUrl = `https://gmgn.ai/sol/address/${w.wallet}`;
                    
                    // Securely building cells
                    tr.innerHTML = `
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-3">
                                <a href="${gmgnUrl}" target="_blank" rel="noopener noreferrer" 
                                   class="text-blue-300 hover:text-blue-100 font-mono text-sm underline decoration-dotted transition-colors">
                                   ${w.wallet.slice(0, 4)}...${w.wallet.slice(-4)}
                                </a>
                                <button class="copy-btn bg-blue-500/30 hover:bg-blue-500/50 text-white w-6 h-6 rounded flex items-center justify-center text-xs transition-all" 
                                        title="Copy address">üìã</button>
                            </div>
                        </td>
                        <td class="text-right py-3 px-4 font-mono">$${w.costUSD.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td class="text-right py-3 px-4 font-mono">${w.balanceAtCheckTime.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td class="text-right py-3 px-4 font-bold text-green-400 font-mono">${w.pctSupply.toFixed(4)}%</td>
                    `;
                    
                    // Add event listener programmatically to the button we just created
                    const btn = tr.querySelector('.copy-btn');
                    btn.onclick = () => copyToClipboard(w.wallet, btn);

                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                tableContainer.appendChild(table);
            }

            document.getElementById('resultsPanel').classList.remove('hidden');
        }
    </script>
</body>
</html>
